#!/usr/bin/env sh
# SSH as root user and create a new user
adduser username
usermod -aG sudo username
ufw allow OpenSSH
ufw enable
rsync --archive --chown=username:username ~/.ssh /home/username
exit

# SSH to your server as your new user
# update and install required modules
sudo apt update
sudo apt install nginx mysql-server php8.1-fpm php-mysql php-cli unzip nodejs npm -y

# allow nginx through the firewall
sudo ufw allow 'Nginx Full'

# -------------------- #
# --- MySQL Config --- #
# -------------------- #
# mysql add local/remote users and update root user
sudo mysql
# refer to /sql/users.sql (in the repo and execute commands)

sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf # set bind address = 0.0.0.0

sudo mysql_secure_installation
sudo systemctl restart mysql

# -------------------- #
# --- Nginx Config --- #
# -------------------- #
sudo mkdir /var/www/domain.com
sudo chown -R $USER:$USER /var/www/domain.com

sudo nano /etc/nginx/sites-available/domain.com
sudo ln -s /etc/nginx/sites-available/mtgcollect.com /etc/nginx/sites-enabled/

sudo nginx -t
sudo systemctl reload nginx

nano /var/www/domain.com/public/index.php

# ------------------------------- #
# --- Install SSL Certificate --- #
# ------------------------------- #
sudo snap install core
sudo snap refresh core
sudo snap install --classic certbot
sudo ln -s /snap/bin/certbot /usr/bin/certbot
sudo certbot --nginx -d domain.com -d www.domain.com

sudo systemctl status snap.certbot.renew.service
sudo certbot renew --dry-run

# ---------------------- #
# --- Composer Setup --- #
# ---------------------- #
curl -sS https://getcomposer.org/installer -o /tmp/composer-setup.php
HASH=`curl -sS https://composer.github.io/installer.sig`
php -r "if (hash_file('SHA384', '/tmp/composer-setup.php') === '$HASH') { echo 'Installer verified'; } else { echo 'Installer corrupt'; unlink('composer-setup.php'); } echo PHP_EOL;"
sudo php /tmp/composer-setup.php --install-dir=/usr/local/bin --filename=composer

# ------------------------ #
# --- Git Setup/Config --- #
# ------------------------ #
sudo apt install git
git config --global user.name "username"
git config --global user.email "email@example.com"